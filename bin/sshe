#!/bin/bash

THEME=$HOME/Projects/trsh/themes/powerline.sh
. $THEME

SSHE_DEPTH=0

function sshe() {
    SSHE_DEPTH=$(($SSHE_DEPTH + 1))
    [[ "$(type -t sshe.set_sshe)" == "function" ]] && sshe.set_sshe
    ssh -tt $@ "$SSHE; export -f _sshe; _sshe $SSHE_DEPTH"
}

function sshe.import() {
    alias
}

function _sshe.load_func() {
    declare -f $1
    echo "export -f $1"
}

SSHE=$(cat << END
function _sshe() {
    SSHE_DEPTH=\$1
    export SSHE_DEPTH

    $(_sshe.load_func theme.define)
    $(_sshe.load_func theme.eval)
    $(_sshe.load_func sshe.import)
    $(_sshe.load_func sshe)

    function sshe.load_theme() {
        theme.define
        theme.eval
        PROMPT_COMMAND="theme.eval"
        export PROMPT_COMMAND
        export PS1
    }
    export -f sshe.load_theme

    function sshe.set_sshe() {
        SSHE="\$(declare -f _sshe)"
    }
    export -f sshe.set_sshe

    sshe.load_theme
    exec bash  --norc --noprofile -i
}
END
)
eval "$SSHE"
SSHE=$(declare -f _sshe)

sshe $@
